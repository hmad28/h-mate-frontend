<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Map Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-dot {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pulse-dot {
            animation: pulse-dot 2s infinite;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        #map {
            background: #1e293b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 to-slate-900 text-white min-h-screen p-5">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-3">
                üåç Visitor Analytics
            </h1>
            <p class="text-slate-400">Real-time visitor tracking & geolocation</p>
            <button 
                onclick="clearData()" 
                class="mt-3 px-4 py-2 bg-red-500/20 border border-red-500/30 text-red-400 rounded-lg text-sm hover:bg-red-500/30 transition"
            >
                Clear All Data
            </button>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div class="bg-slate-900/60 backdrop-blur-xl border border-slate-800/50 rounded-2xl p-6 hover:translate-y-[-5px] hover:border-blue-500/50 transition-all">
                <div class="text-sm text-slate-400 mb-2">Total Visitors</div>
                <div class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent" id="totalVisitors">0</div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl border border-slate-800/50 rounded-2xl p-6 hover:translate-y-[-5px] hover:border-blue-500/50 transition-all">
                <div class="text-sm text-slate-400 mb-2">Unique Countries</div>
                <div class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent" id="uniqueCountries">0</div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl border border-slate-800/50 rounded-2xl p-6 hover:translate-y-[-5px] hover:border-blue-500/50 transition-all">
                <div class="text-sm text-slate-400 mb-2">Today's Visits</div>
                <div class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent" id="todayVisits">0</div>
            </div>
            <div class="bg-slate-900/60 backdrop-blur-xl border border-slate-800/50 rounded-2xl p-6 hover:translate-y-[-5px] hover:border-blue-500/50 transition-all">
                <div class="text-sm text-slate-400 mb-2 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
                    Online Now
                </div>
                <div class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent" id="onlineNow">0</div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="bg-slate-900/60 backdrop-blur-xl border border-slate-800/50 rounded-2xl p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-blue-400">üó∫Ô∏è Visitor Map</h2>
                <div class="text-xs bg-green-500/20 border border-green-500/30 text-green-400 px-3 py-1 rounded-full">
                    GPS Enabled
                </div>
            </div>
            <div id="map" class="h-[500px] rounded-xl"></div>
            <div class="mt-4 text-xs text-slate-500 text-center">
                API Provider: <span id="apiProvider">Loading...</span>
            </div>
            <div class="mt-2 text-xs text-slate-400 text-center">
                üí° Tip: Allow location access for accurate GPS-based tracking
            </div>
        </div>

        <!-- Recent Visitors -->
        <div class="bg-slate-900/60 backdrop-blur-xl border border-slate-800/50 rounded-2xl p-6">
            <h2 class="text-2xl font-bold text-purple-400 mb-4">üë• Recent Visitors</h2>
            <div id="visitorsList">
                <div class="text-center py-10">
                    <div class="w-10 h-10 border-3 border-blue-400 border-t-transparent rounded-full spinner mx-auto mb-4"></div>
                    <div class="text-slate-400">Loading visitor data...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var visitorData = [];
        var map;
        var markers = [];

        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxZoom: 18,
                worldCopyJump: true,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                noWrap: true
            }).addTo(map);
        }

        // Get country flag emoji
        function getFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) return 'üåç';
            var codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(function(char) { 
                    return 127397 + char.charCodeAt(0); 
                });
            return String.fromCodePoint.apply(String, codePoints);
        }

        // Format time ago
        function timeAgo(date) {
            var seconds = Math.floor((new Date() - new Date(date)) / 1000);
            
            if (seconds < 60) return seconds + 's ago';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Get location from browser geolocation API (most accurate)
        function getBrowserLocation() {
            return new Promise(function(resolve) {
                if (!navigator.geolocation) {
                    console.log('Browser geolocation not supported');
                    resolve(null);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('‚úÖ Browser geolocation success:', position.coords);
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    function(error) {
                        console.log('‚ùå Browser geolocation denied or failed:', error.message);
                        resolve(null);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Reverse geocode coordinates to get city/country
        async function reverseGeocode(lat, lon) {
            try {
                var response = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon);
                var data = await response.json();
                
                if (data.address) {
                    return {
                        city: data.address.city || data.address.town || data.address.village || data.address.county,
                        country: data.address.country,
                        countryCode: data.address.country_code ? data.address.country_code.toUpperCase() : null,
                        region: data.address.state || data.address.region
                    };
                }
            } catch (error) {
                console.error('Reverse geocode error:', error);
            }
            return null;
        }

        // Track current visitor - Hybrid: GPS first, fallback to IP
        async function trackVisitor() {
            // TRY 1: Browser Geolocation (GPS/WiFi) - MEMINTA IZIN USER
            var browserLoc = await getBrowserLocation();
            
            if (browserLoc) {
                console.log('‚úÖ Using browser geolocation (GPS/WiFi based) - USER MENGIZINKAN');
                
                // Get city/country from coordinates
                var geoData = await reverseGeocode(browserLoc.lat, browserLoc.lon);
                
                // Get IP info for additional data
                var ipInfo = null;
                try {
                    var ipResponse = await fetch('https://api.ipify.org?format=json');
                    var ipData = await ipResponse.json();
                    ipInfo = ipData.ip;
                } catch (e) {
                    ipInfo = 'Unknown';
                }
                
                var visitor = {
                    ip: ipInfo,
                    country: geoData ? geoData.country : 'Unknown',
                    countryCode: geoData ? geoData.countryCode : 'XX',
                    city: geoData ? geoData.city : 'Unknown',
                    region: geoData ? geoData.region : 'Unknown',
                    lat: browserLoc.lat,
                    lon: browserLoc.lon,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    provider: 'Browser GPS (¬±' + Math.round(browserLoc.accuracy) + 'm)',
                    accuracy: browserLoc.accuracy
                };
                
                console.log('‚úÖ Successfully tracked with GPS:', visitor);
                document.getElementById('apiProvider').textContent = visitor.provider;
                
                // Store in localStorage
                var stored = JSON.parse(localStorage.getItem('visitors') || '[]');
                var fiveMinAgo = Date.now() - 5 * 60 * 1000;
                var isDuplicate = stored.some(function(v) {
                    return v.ip === visitor.ip && new Date(v.timestamp).getTime() > fiveMinAgo;
                });
                
                if (!isDuplicate) {
                    stored.unshift(visitor);
                    if (stored.length > 100) stored = stored.slice(0, 100);
                    localStorage.setItem('visitors', JSON.stringify(stored));
                }
                
                return visitor;
            }
            
            // TRY 2: IP Geolocation - FALLBACK (TANPA IZIN)
            console.log('‚ùå Browser geolocation not available, trying IP-based... USER TIDAK MENGIZINKAN atau BROWSER TIDAK SUPPORT');
            
            var providers = [
                {
                    name: 'ipapi.co',
                    url: 'https://ipapi.co/json/',
                    parse: function(data) {
                        if (data.error) return null;
                        return {
                            ip: data.ip,
                            country: data.country_name,
                            countryCode: data.country_code,
                            city: data.city,
                            region: data.region,
                            lat: data.latitude,
                            lon: data.longitude
                        };
                    }
                },
                {
                    name: 'ip-api.com',
                    url: 'http://ip-api.com/json/?fields=status,country,countryCode,regionName,city,lat,lon,query',
                    parse: function(data) {
                        if (data.status !== 'success') return null;
                        return {
                            ip: data.query,
                            country: data.country,
                            countryCode: data.countryCode,
                            city: data.city,
                            region: data.regionName,
                            lat: data.lat,
                            lon: data.lon
                        };
                    }
                },
                {
                    name: 'ipwhois.app',
                    url: 'https://ipwhois.app/json/',
                    parse: function(data) {
                        if (!data.success) return null;
                        return {
                            ip: data.ip,
                            country: data.country,
                            countryCode: data.country_code,
                            city: data.city,
                            region: data.region,
                            lat: data.latitude,
                            lon: data.longitude
                        };
                    }
                }
            ];

            for (var i = 0; i < providers.length; i++) {
                try {
                    console.log('Trying IP provider:', providers[i].name);
                    var response = await fetch(providers[i].url);
                    var rawData = await response.json();
                    console.log('Raw response from', providers[i].name, ':', rawData);
                    
                    var parsed = providers[i].parse(rawData);
                    
                    if (parsed && parsed.lat && parsed.lon) {
                        var visitor = {
                            ip: parsed.ip,
                            country: parsed.country,
                            countryCode: parsed.countryCode,
                            city: parsed.city,
                            region: parsed.region,
                            lat: parsed.lat,
                            lon: parsed.lon,
                            timestamp: new Date().toISOString(),
                            userAgent: navigator.userAgent,
                            provider: providers[i].name + ' (IP-based)',
                            accuracy: null
                        };
                        
                        console.log('‚úÖ Successfully tracked with IP geolocation:', visitor);
                        document.getElementById('apiProvider').textContent = visitor.provider;
                        
                        // Store in localStorage
                        var stored = JSON.parse(localStorage.getItem('visitors') || '[]');
                        var fiveMinAgo = Date.now() - 5 * 60 * 1000;
                        var isDuplicate = stored.some(function(v) {
                            return v.ip === visitor.ip && new Date(v.timestamp).getTime() > fiveMinAgo;
                        });
                        
                        if (!isDuplicate) {
                            stored.unshift(visitor);
                            if (stored.length > 100) stored = stored.slice(0, 100);
                            localStorage.setItem('visitors', JSON.stringify(stored));
                        } else {
                            console.log('Duplicate visitor within 5 minutes, skipping...');
                        }
                        
                        return visitor;
                    } else {
                        console.log('‚ùå Provider', providers[i].name, 'returned invalid data');
                    }
                } catch (error) {
                    console.error('Error with provider', providers[i].name, ':', error);
                }
            }
            
            console.error('‚ùå All providers failed');
            document.getElementById('apiProvider').textContent = 'All providers failed';
            return null;
        }

        // Load visitor data
        function loadVisitors() {
            var stored = localStorage.getItem('visitors');
            if (stored) {
                visitorData = JSON.parse(stored);
                console.log('Loaded', visitorData.length, 'visitors from storage');
            } else {
                visitorData = [];
                console.log('No stored visitors found');
            }
            
            updateStats();
            updateMap();
            updateVisitorsList();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalVisitors').textContent = visitorData.length;
            
            var countries = new Set(visitorData.map(function(v) { return v.country; }));
            document.getElementById('uniqueCountries').textContent = countries.size;
            
            var today = new Date().toDateString();
            var todayCount = visitorData.filter(function(v) {
                return new Date(v.timestamp).toDateString() === today;
            }).length;
            document.getElementById('todayVisits').textContent = todayCount;
            
            var fiveMinAgo = Date.now() - 5 * 60 * 1000;
            var onlineCount = visitorData.filter(function(v) {
                return new Date(v.timestamp).getTime() > fiveMinAgo;
            }).length;
            document.getElementById('onlineNow').textContent = onlineCount;
        }

        // Update map markers
        function updateMap() {
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            markers = [];
            
            visitorData.forEach(function(visitor) {
                if (visitor.lat && visitor.lon) {
                    var marker = L.circleMarker([visitor.lat, visitor.lon], {
                        radius: 6,
                        fillColor: '#60a5fa',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(
                        '<div style="color: #000">' +
                        '<b>' + (visitor.city || 'Unknown') + '</b><br>' +
                        visitor.country + '<br>' +
                        '<small>IP: ' + visitor.ip + '</small><br>' +
                        '<small>' + timeAgo(visitor.timestamp) + '</small><br>' +
                        '<small>Provider: ' + visitor.provider + '</small>' +
                        '</div>'
                    );
                    
                    markers.push(marker);
                }
            });
        }

        // Update visitors list
        function updateVisitorsList() {
            var listEl = document.getElementById('visitorsList');
            
            if (visitorData.length === 0) {
                listEl.innerHTML = '<div class="text-center py-10 text-slate-400">No visitors yet. Refresh the page to track yourself!</div>';
                return;
            }
            
            var html = '';
            var recentVisitors = visitorData.slice(0, 20);
            
            recentVisitors.forEach(function(visitor) {
                var isRecent = (Date.now() - new Date(visitor.timestamp).getTime()) < 5 * 60 * 1000;
                
                html += '<div class="bg-slate-950/50 border border-slate-800/50 rounded-xl p-4 mb-3 flex items-center gap-4 hover:bg-slate-950/80 hover:border-blue-500/30 hover:translate-x-1 transition-all">';
                html += '<div class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center text-2xl flex-shrink-0">';
                html += getFlag(visitor.countryCode);
                html += '</div>';
                html += '<div class="flex-1 min-w-0">';
                html += '<div class="font-semibold text-white flex items-center gap-2">';
                if (isRecent) html += '<span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>';
                html += '<span class="truncate">' + (visitor.city || 'Unknown') + ', ' + visitor.country + '</span>';
                html += '</div>';
                html += '<div class="text-sm text-slate-400 truncate">IP: ' + visitor.ip + ' ‚Ä¢ ' + timeAgo(visitor.timestamp) + '</div>';
                html += '<div class="text-xs text-slate-500">Provider: ' + visitor.provider + '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            listEl.innerHTML = html;
        }

        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to clear all visitor data?')) {
                localStorage.removeItem('visitors');
                visitorData = [];
                updateStats();
                updateMap();
                updateVisitorsList();
                alert('All data cleared! Refresh the page to track yourself again.');
            }
        }

        // Initialize everything
        async function init() {
            initMap();
            
            // Load existing data first
            loadVisitors();
            
            // Then track current visitor (akan minta izin GPS atau fallback ke IP)
            await trackVisitor();
            
            // Reload data after tracking
            loadVisitors();
            
            // Update time ago every 30 seconds
            setInterval(function() {
                updateVisitorsList();
            }, 30000);
        }

        window.onload = init;
    </script>
</body>
</html>