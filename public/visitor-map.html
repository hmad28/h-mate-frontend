<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Map Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 20px;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(96, 165, 250, 0.5);
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .map-container {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .map-container h2 {
            margin-bottom: 15px;
            color: #60a5fa;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            background: #1e293b;
        }

        .visitors-list {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 20px;
        }

        .visitors-list h2 {
            margin-bottom: 15px;
            color: #a78bfa;
        }

        .visitor-item {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .visitor-item:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(96, 165, 250, 0.3);
            transform: translateX(5px);
        }

        .visitor-flag {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 50%;
        }

        .visitor-info {
            flex: 1;
        }

        .visitor-info .location {
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .visitor-info .time {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .spinner {
            border: 3px solid rgba(96, 165, 250, 0.2);
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            #map {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Visitor Analytics</h1>
            <p style="color: #94a3b8;">Real-time visitor tracking & geolocation</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Total Visitors</div>
                <div class="value" id="totalVisitors">0</div>
            </div>
            <div class="stat-card">
                <div class="label">Unique Countries</div>
                <div class="value" id="uniqueCountries">0</div>
            </div>
            <div class="stat-card">
                <div class="label">Today's Visits</div>
                <div class="value" id="todayVisits">0</div>
            </div>
            <div class="stat-card">
                <div class="label"><span class="pulse"></span>Online Now</div>
                <div class="value" id="onlineNow">0</div>
            </div>
        </div>

        <div class="map-container">
            <h2>üó∫Ô∏è Visitor Map</h2>
            <div id="map"></div>
        </div>

        <div class="visitors-list">
            <h2>üë• Recent Visitors</h2>
            <div id="visitorsList">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading visitor data...
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var visitorData = [];
        var map;
        var markers = [];

        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxZoom: 18,
                worldCopyJump: true,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                noWrap: true
            }).addTo(map);
        }

        // Get country flag emoji
        function getFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) return 'üåç';
            var codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(function(char) { 
                    return 127397 + char.charCodeAt(0); 
                });
            return String.fromCodePoint.apply(String, codePoints);
        }

        // Format time ago
        function timeAgo(date) {
            var seconds = Math.floor((new Date() - new Date(date)) / 1000);
            
            if (seconds < 60) return seconds + 's ago';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Track current visitor
        async function trackVisitor() {
            try {
                var response = await fetch('https://ipapi.co/json/');
                var data = await response.json();
                
                var visitor = {
                    ip: data.ip,
                    country: data.country_name,
                    countryCode: data.country_code,
                    city: data.city,
                    region: data.region,
                    lat: data.latitude,
                    lon: data.longitude,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                };
                
                // Store in localStorage (simulating database)
                var stored = JSON.parse(localStorage.getItem('visitors') || '[]');
                stored.unshift(visitor);
                
                // Keep only last 100 visitors
                if (stored.length > 100) stored = stored.slice(0, 100);
                
                localStorage.setItem('visitors', JSON.stringify(stored));
                
                return visitor;
            } catch (error) {
                console.error('Error tracking visitor:', error);
                return null;
            }
        }

        // Load visitor data
        function loadVisitors() {
            var stored = localStorage.getItem('visitors');
            if (stored) {
                visitorData = JSON.parse(stored);
            } else {
                // Demo data if no visitors yet
                visitorData = [
                    {
                        country: 'Indonesia',
                        countryCode: 'ID',
                        city: 'Jakarta',
                        lat: -6.2088,
                        lon: 106.8456,
                        timestamp: new Date().toISOString()
                    },
                    {
                        country: 'United States',
                        countryCode: 'US',
                        city: 'New York',
                        lat: 40.7128,
                        lon: -74.0060,
                        timestamp: new Date(Date.now() - 3600000).toISOString()
                    },
                    {
                        country: 'United Kingdom',
                        countryCode: 'GB',
                        city: 'London',
                        lat: 51.5074,
                        lon: -0.1278,
                        timestamp: new Date(Date.now() - 7200000).toISOString()
                    }
                ];
            }
            
            updateStats();
            updateMap();
            updateVisitorsList();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalVisitors').textContent = visitorData.length;
            
            var countries = new Set(visitorData.map(function(v) { return v.country; }));
            document.getElementById('uniqueCountries').textContent = countries.size;
            
            var today = new Date().toDateString();
            var todayCount = visitorData.filter(function(v) {
                return new Date(v.timestamp).toDateString() === today;
            }).length;
            document.getElementById('todayVisits').textContent = todayCount;
            
            var fiveMinAgo = Date.now() - 5 * 60 * 1000;
            var onlineCount = visitorData.filter(function(v) {
                return new Date(v.timestamp).getTime() > fiveMinAgo;
            }).length;
            document.getElementById('onlineNow').textContent = onlineCount;
        }

        // Update map markers
        function updateMap() {
            // Clear existing markers
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            markers = [];
            
            // Add markers for each visitor
            visitorData.forEach(function(visitor) {
                if (visitor.lat && visitor.lon) {
                    var marker = L.circleMarker([visitor.lat, visitor.lon], {
                        radius: 6,
                        fillColor: '#60a5fa',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(
                        '<b>' + (visitor.city || 'Unknown') + '</b><br>' +
                        visitor.country + '<br>' +
                        '<small>' + timeAgo(visitor.timestamp) + '</small>'
                    );
                    
                    markers.push(marker);
                }
            });
        }

        // Update visitors list
        function updateVisitorsList() {
            var listEl = document.getElementById('visitorsList');
            
            if (visitorData.length === 0) {
                listEl.innerHTML = '<div class="loading">No visitors yet</div>';
                return;
            }
            
            var html = '';
            var recentVisitors = visitorData.slice(0, 20);
            
            recentVisitors.forEach(function(visitor) {
                var isRecent = (Date.now() - new Date(visitor.timestamp).getTime()) < 5 * 60 * 1000;
                
                html += '<div class="visitor-item">';
                html += '<div class="visitor-flag">' + getFlag(visitor.countryCode) + '</div>';
                html += '<div class="visitor-info">';
                html += '<div class="location">';
                if (isRecent) html += '<span class="pulse"></span>';
                html += (visitor.city || 'Unknown') + ', ' + visitor.country;
                html += '</div>';
                html += '<div class="time">' + timeAgo(visitor.timestamp) + '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            listEl.innerHTML = html;
        }

        // Initialize everything
        async function init() {
            initMap();
            
            // Track current visitor
            await trackVisitor();
            
            // Load and display data
            loadVisitors();
            
            // Update time ago every 30 seconds
            setInterval(function() {
                updateVisitorsList();
            }, 30000);
        }

        // Start when page loads
        window.onload = init;
    </script>
</body>
</html>